/*
 * main_hmi.c
 *
 *  Created on: 1 Nov 2024
 *      Author: farah
 */
#include"keypad.h"
#include"lcd.h"
#include"uart.h"
#include"timer.h"
#include <util/delay.h> /* For the delay functions */
int flagg=0;



#define MATCH 0x11
#define MISMATCH 0x22
#define DOOR 0x01
#define CHANGEPASS 0x02
#define MOTION 0x03
#define NOMOTION 0x04
#define WARNING 0x05

void mainoptions(void);
void first_time_password(void);

int tick=0;
//////////////////////////////////////////////
void timernewtick(void)
{
	tick++;
}

////////////////////////////////////////////////////////////////////////////////////
void opendoor(void)
{
	int i=0; uint8 passdoor[7];
	while(flagg<3)
	{
	   LCD_displayString("Plz enter PASS");
		while(i<5)
		{
			uint8 num=KEYPAD_getPressedKey();
			if(((num>=1)&&(num<=9)))
		 	{
			passdoor[i]=KEYPAD_getPressedKey();
			LCD_moveCursor(1,i);
			LCD_displayCharacter('*');
			i++;
			}
			_delay_ms(500); /* Press time */
		}
	   while(KEYPAD_getPressedKey()!='='){}
		passdoor[5]='#';
        UART_sendByte(DOOR);
        _delay_ms(100);
		UART_sendString(passdoor);
        if(UART_receiveByte()==MATCH)
        {

        	   LCD_clearScreen();
        	    LCD_displayString("Unlocking door");
        	    tick=0;
              while(tick<=3){}
              LCD_clearScreen(); /*madkhlsh hna*/
				if(UART_receiveByte()==MOTION)
				{
					LCD_clearScreen();
					LCD_displayString("wait for people");

				}
				if(UART_receiveByte()==NOMOTION)
				{
					    tick=0;
					    LCD_clearScreen();
						LCD_displayString("locking door");
						while(tick<=3){}

				}
            return;
         }
        else
        {
        	flagg++;
        	LCD_clearScreen();
        	opendoor();
        	return;
        }
	}
	UART_sendByte(WARNING);
	LCD_displayString("WARNING FAIL  ");
	mainoptions();

}
/////////////////////////////////////////////////////////////////////////////////////////
void changepass(void)
{
	int i=0; uint8 passchange[7]; int flag=0;
	    while(flag<3)
	    {
		LCD_displayString("Plz enter PASS");
			while(i<5)
			{
				uint8 num=KEYPAD_getPressedKey();
				if(((num>=1)&&(num<=9)))
				{
				passchange[i]=KEYPAD_getPressedKey();
				LCD_moveCursor(1,i);
				LCD_displayCharacter('*');
				i++;
				}
				_delay_ms(500); /* Press time */
			}
		   while(KEYPAD_getPressedKey()!='='){}
			passchange[5]='#';
			UART_sendByte(CHANGEPASS);

			UART_sendString(passchange);
					if(UART_receiveByte()==MATCH)
					{
						LCD_clearScreen();
						 first_time_password();
						 return;
					}
					else if(UART_receiveByte()==MISMATCH)
					{
						flag++;
						LCD_clearScreen();
						changepass();
						return;
					}
			}
							UART_sendByte(WARNING);
							LCD_displayString("WARNING FAIL  ");
							mainoptions();




}
///////////////////////////////////////////////////////////////////////////////////////////////
void mainoptions(void)
{
	LCD_displayStringRowColumn(0,0,"+:Open door   ");
	LCD_displayStringRowColumn(1,0,"-:Change pass   ");
	uint8 key=KEYPAD_getPressedKey();
	if(key=='+')
	{
		LCD_clearScreen();
		opendoor();
	}
	else if(key=='-')
	{
		LCD_clearScreen();
        changepass();
	}
}

////////////////////////////////////////////////////////////////////////////////////////////////
void first_time_password(void)
{
	int i=0,k=0; uint8 pass[7]; uint8 passcheck[7]; uint8 repeat=0;
	        LCD_displayString("Plz enter PASS");

			    while(i<5)
			    {
			    	uint8 num=KEYPAD_getPressedKey();
			    	if(((num>=1)&&(num<=9)))
					{
					pass[i]=KEYPAD_getPressedKey();
					LCD_moveCursor(1,i);
					LCD_displayCharacter('*');
					i++;
					}
			    	_delay_ms(500); /* Press time */
			    }
            while(KEYPAD_getPressedKey()!='='){}
			    pass[5]='#';
			LCD_clearScreen();
			LCD_displayString("Please re-enter PASS");
			while(k<5)
			{
				uint8 num=KEYPAD_getPressedKey();
				if(((num>=1)&&(num<=9)))
				{
				passcheck[k]=KEYPAD_getPressedKey();
				LCD_moveCursor(1,k);
				LCD_displayCharacter('*');
				k++;
				}
				_delay_ms(500); /* Press time */
			}
			while(KEYPAD_getPressedKey()!='='){}
			passcheck[5]='#';
			/*CHECK*/
			for(i=0;i<5;i++)
			{
			if(pass[i]!=passcheck[i])
				{
					repeat=1;
				}
			}
			if(repeat==1)
			{
				LCD_clearScreen();
				first_time_password();
			}
			else
			{
				LCD_clearScreen();
				UART_sendString(pass);
				LCD_displayString("PASS SAVED   ");
				mainoptions();
			}

}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
int main(void)
{
	Timer_ConfigType timer = {0, 31250, TIMER1, PRESCALER_256,COMPARE_MATCH};
    Timer_init(&timer);
	LCD_init();
	UART_ConfigType uart_cfg = {BITS_MODE_8,NO_PARITY,STOPBIT_1BIT, BAUDRATE_9600};
		UART_init(&uart_cfg);
	Timer_setCallBack(timernewtick, TIMER1);
	first_time_password();
	while(1)
	{

	}
}
