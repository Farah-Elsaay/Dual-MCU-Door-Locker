/*
 * main_hmi.c
 *
 *  Created on: 1 Nov 2024
 *      Author: farah
 */
/*
 ============================================================================
 Name        : hmi_ecu.c
 Author      : Abdelrahman Essa
 Date        : 2/11/2024
 Description : Human Interface ECU Handler
 ============================================================================
 */

/************** Includes **************/
#include "std_types.h"
#include <util/delay.h>
#include <avr/interrupt.h>
#include "uart.h"
#include "timer.h"
#include "lcd.h"
#include "keypad.h"

#define NEW_PASS       0x01
#define DOOR_PASS_IN          0x02
#define PASS_UPDATE      0x03
#define MATCH     0x04
#define MISMATCH       0x05
#define MOTION       0x06
#define NO_MOTION       0x07
#define WARNING          0x08

/* Array to Store Password */
uint8 pass[5] = {0};
uint8 pass2[5]={0};
uint8 i = 0;
uint8 twopasswords = 0;
uint8 key = 0;
uint8 tick = 0;
uint8 enter_fails = 0;
uint8 update_fails = 0;
uint8 motion_status = 0;

void new_timer_tick(void)
{
	++tick;
}

int main()
{
	/********** Initializations **********/
	/* LCD Initialization */
	LCD_init();

	/* UART Initialization */
	UART_ConfigType UART_CONFIGURATIONS = {BITS_MODE_8,NO_PARITY, STOPBIT_1BIT, 9600};
	UART_init(&UART_CONFIGURATIONS);

	/* Creating timer 1 object to count time */
	sei();
	Timer_ConfigType TIMER_CONFIGURATIONS = {0, 31250, TIMER1, PRESCALER_256, CTC};
	Timer_init(&TIMER_CONFIGURATIONS);
	Timer_setCallBack(new_timer_tick, TIMER1);

	/* Enter Password for the first Time */
	while(twopasswords != MATCH)
	{
		UART_sendByte(NEW_PASS);
		LCD_clearScreen();
		LCD_displayString("PLZ enter PASS");
		LCD_moveCursor(1, 0);
		for(i = 0; i < 5; ++i)
		{
			pass[i] = KEYPAD_getPressedKey();
			LCD_displayCharacter('*');
			_delay_ms(500);
		}
		while(KEYPAD_getPressedKey() != '=');
		_delay_ms(500);
		LCD_clearScreen();
		LCD_displayString("PLZ RE-ENTER");
		LCD_displayStringRowColumn(1, 0, " ") ;
		_delay_ms(500);
		for(i = 0; i < 5; ++i)
		{
			pass2[i] = KEYPAD_getPressedKey();
			LCD_displayCharacter('*');
			_delay_ms(500);
		}
		while(KEYPAD_getPressedKey() != '=');
		_delay_ms(500);

		/* Sending Password to Control ECU Using UART */
		for(i = 0; i < 5; ++i)
		{
			UART_sendByte(pass[i]);
		}
		for(i = 0; i < 5; ++i)
		{
			UART_sendByte(pass2[i]);
		}

		/* Checking pass */
		twopasswords = UART_receiveByte();
		if(twopasswords == MISMATCH)
		{
			/* the program will return to entering password again */
			LCD_clearScreen();
			LCD_displayString("WRONG PASS");
			tick = 0;
			while(tick< 3);
		}
	}

	/************** Program **************/
	for(;;)
	{
		/* Entering main window */
		LCD_clearScreen();
		LCD_displayString("+ : OPEN DOOR");
		LCD_displayStringRowColumn(1, 0, "- : CHANGE PASS");

		/* Waiting for user order */
		do{
			key = KEYPAD_getPressedKey();
		}while(key != '+' && key != '-');

		/* Checking order type */
		if(key == '+')
		{
			/* Waiting for user to enter old password */
			UART_sendByte(DOOR_PASS_IN);
			LCD_clearScreen();
			LCD_displayString("PLZ enter PASS");
			LCD_displayStringRowColumn(1, 0, " ");
			_delay_ms(500);
			for(i = 0; i < 5; ++i)
			{
				pass[i] = KEYPAD_getPressedKey();
				LCD_displayCharacter('*');
				_delay_ms(500);
			}
			while(KEYPAD_getPressedKey() != '=');
			_delay_ms(500);

			/* Sending Password to Control ECU Using UART */
			for(i = 0; i < 5; ++i)
			{
				UART_sendByte(pass[i]);
			}

			/* Checking pass */
			twopasswords = UART_receiveByte();
			if(twopasswords == MATCH)
			{
				enter_fails = 0;
				/* Open door for 15 seconds */
				LCD_clearScreen();
				LCD_displayStringRowColumn(0, 1, "Door Unlocking");
				LCD_displayStringRowColumn(1, 3, "Please Wait");
				tick = 0;
				while(tick < 15);

				/* Check people entering */
				LCD_clearScreen();
				motion_status = UART_receiveByte();
				while(motion_status == MOTION)
				{
					LCD_displayStringRowColumn(0, 0, "Wait for People");
					LCD_displayStringRowColumn(1, 3, "to Enter");
					motion_status = UART_receiveByte();
				}
				if(motion_status == NO_MOTION)
				{
					LCD_clearScreen();
					LCD_displayStringRowColumn(0, 2, "Door Locking");
					tick = 0;
					while(tick < 15);
				}
			}
			else if(twopasswords == MISMATCH)
			{
				++enter_fails;
				if(enter_fails == 3)
				{
					/* Lock system for 1 minute */
					UART_sendByte(WARNING);
					LCD_clearScreen();
					LCD_displayStringRowColumn(0, 1, "System LOCKED");
					LCD_displayStringRowColumn(1, 0, "Wait for 1 min");
					tick = 0;
					while(tick < 60);
					enter_fails = 0;
				}
				else
				{
					/* the program will return to entering password again */
					LCD_clearScreen();
					LCD_displayString("WRONG PASS");
					tick= 0;
					while(tick < 3);
				}
			}
		}
		else if(key == '-')
		{
			/* Waiting for user to enter old password */
			UART_sendByte(PASS_UPDATE);
			LCD_clearScreen();
			LCD_displayString("PLZ enter PASS");
			LCD_displayStringRowColumn(1, 0, " ");
			_delay_ms(500);
			for(i = 0; i < 5; ++i)
			{
				pass[i] = KEYPAD_getPressedKey();
				LCD_displayCharacter('*');
				_delay_ms(500);
			}
			while(KEYPAD_getPressedKey() != '=');
			_delay_ms(500);

			/* Sending Password to Control ECU Using UART */
			for(i = 0; i < 5; ++i)
			{
				UART_sendByte(pass[i]);
			}

			/* Checking pass */
			twopasswords = UART_receiveByte();
			if(twopasswords == MATCH)
			{
				update_fails = 0;
				LCD_clearScreen();
				LCD_displayString("PLZ enter PASS");
				LCD_moveCursor(1, 0);
				for(i = 0; i < 5; ++i)
				{
					pass[i] = KEYPAD_getPressedKey();
					LCD_displayCharacter('*');
					_delay_ms(500);
				}
				while(KEYPAD_getPressedKey() != '=');
				_delay_ms(500);
				LCD_clearScreen();
				LCD_displayString("PLZ RE-ENTER");
				LCD_displayStringRowColumn(1, 0, " ");
				_delay_ms(500);
				for(i = 5; i < 10; ++i)
				{
					pass[i] = KEYPAD_getPressedKey();
					LCD_displayCharacter('*');
					_delay_ms(500);
				}
				while(KEYPAD_getPressedKey() != '=');
				_delay_ms(500);

				/* Sending Password to Control ECU Using UART */
				for(i = 0; i < 10; ++i)
				{
					UART_sendByte(pass[i]);
				}

				/* Checking pass */
				twopasswords= UART_receiveByte();
				if(twopasswords == MISMATCH)
				{
					/* the program will return to entering password again */
					LCD_clearScreen();
					LCD_displayString("WRONG PASS");
					tick = 0;
					while(tick < 3);
				}
			}
			else if(twopasswords ==MISMATCH)
			{
				++update_fails;
				if(update_fails == 3)
				{
					/* Lock system for 1 minute */
					LCD_clearScreen();
					LCD_displayStringRowColumn(0, 1, "System LOCKED");
					LCD_displayStringRowColumn(1, 0, "Wait for 1 min");
					tick = 0;
					while(tick < 60);
					update_fails = 0;
				}
				else
				{
					/* the program will return to entering password again */
					LCD_clearScreen();
					LCD_displayString("WRONG PASS");
					tick = 0;
					while(tick < 3);
				}
			}
		}
	}
}
